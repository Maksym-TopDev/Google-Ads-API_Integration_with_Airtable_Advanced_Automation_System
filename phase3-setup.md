# Phase 3 Setup Guide - AI Ad Generation Auto-Trigger

## Overview
Phase 3 automatically generates new ad variants when the "Meets Threshold" checkbox is checked in the Ads table.

## Prerequisites

### 1. Environment Variables
Add these to your `.env` file:

```env
# OpenAI Configuration
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4  # or gpt-3.5-turbo for cost savings

# Your existing variables...
GOOGLE_ADS_DEVELOPER_TOKEN=your_developer_token
GOOGLE_ADS_OAUTH_CLIENT_ID=your_client_id
GOOGLE_ADS_OAUTH_CLIENT_SECRET=your_client_secret
GOOGLE_ADS_REFRESH_TOKEN=your_refresh_token
GOOGLE_ADS_CUSTOMER_ID=your_customer_id
GOOGLE_ADS_MCC_CUSTOMER_ID=your_mcc_customer_id
GOOGLE_ADS_API_VERSION=v21

# Airtable Configuration
AIRTABLE_PAT=your_airtable_personal_access_token
AIRTABLE_BASE_ID=your_airtable_base_id
```

### 2. Install Dependencies
```bash
npm install
```

### 3. Airtable Table Structure

#### Ads Table (add these fields)
- `Meets Threshold` (Checkbox) - Triggers Phase 3
- `Last Generation Status` (Single line text) - Shows generation result
- `Last Generation Time` (Date & time) - When last generated
- `Variants Generated` (Number) - How many variants created
- `Generation Error` (Long text) - Error details if failed

#### Ad Generator Table
Create this new table with these fields:

| Field Name | Type | Purpose |
|------------|------|---------|
| `Campaign ID` | Single line text | Google Ads campaign |
| `Ad Group ID` | Single line text | Google Ads ad group |
| `Campaign Name` | Single line text | Campaign name |
| `Ad Group Name` | Single line text | Ad group name |
| `Source Ad ID` | Single line text | ID of winning ad |
| `Performance Score` | Number | CTR + ROAS + CR score |
| `Headline 1` | Single line text | Generated headline |
| `Headline 2` | Single line text | Generated headline |
| `Headline 3` | Single line text | Generated headline |
| `Description 1` | Single line text | Generated description |
| `Description 2` | Single line text | Generated description |
| `Path1` | Single line text | Generated path 1 |
| `Path2` | Single line text | Generated path 2 |
| `Final URL` | URL | Destination URL |
| `Generated By` | Single select | Options: `OpenAI GPT`, `Manual` |
| `Validation Status` | Single line text | ✅ Ready / ❌ Error |
| `Send to Queue?` | Checkbox | Auto-set to true |
| `Generation Status` | Single select | Generated, Failed |
| `Approval Status` | Single select | Approved (auto-approved) |
| `Policy Check` | Checkbox | Auto-set to true |
| `Created At` | Date & time | Generation timestamp |

#### Upload Queue Table
Create this new table with these fields:

| Field Name | Type | Purpose |
|------------|------|---------|
| `Queue ID` | Auto | Unique ID |
| `Campaign ID` | Single line text | Target campaign |
| `Ad Group ID` | Single line text | Target ad group |
| `Headlines` | Long text | JSON array of headlines |
| `Descriptions` | Long text | JSON array of descriptions |
| `Path1` | Single line text | Path 1 |
| `Path2` | Single line text | Path 2 |
| `Final URL` | URL | Destination URL |
| `Status` | Single select | Pending, Uploaded, Failed |
| `Priority` | Number | 1=High, 5=Low |
| `Retry Count` | Number | Current retry attempts |
| `Max Retries` | Number | Maximum retries (default 3) |
| `Upload Result` | Long text | API response/error |
| `Google Ads Ad ID` | Single line text | Created ad ID |
| `Created At` | Date & time | Queue timestamp |
| `Uploaded At` | Date & time | Upload completion |

## Setup Steps

### 1. Deploy Your Project
Make sure your project is running and accessible via HTTPS:
```bash
npm run start
```

### 2. Update Airtable Script
1. Copy the script from `airtable-script-phase3.js`
2. Replace `https://your-project-url.com` with your actual project URL
3. Save the script in Airtable

### 3. Create Airtable Automation
1. Go to your Airtable base
2. Click "Automations" in the top menu
3. Click "Create automation"
4. Set up the trigger:
   - **When**: A record is updated
   - **Table**: Ads
   - **Condition**: "Meets Threshold" field changes to "Checked"
5. Add action:
   - **Action**: Run script
   - **Script**: Select your Phase 3 script
6. Test the automation

### 4. Test the Flow
1. Find an ad in your Ads table with good performance
2. Check the "Meets Threshold" checkbox
3. The automation should trigger and call your API
4. Check the Ad Generator table for new records
5. Check the Upload Queue table for queued uploads

## How It Works

1. **Trigger**: User checks "Meets Threshold" in Ads table
2. **Airtable Script**: Calls your API with ad data
3. **API Processing**:
   - Fetches performance data for the ad
   - Gets source ad content for inspiration
   - Calls OpenAI to generate 3 new variants
   - Creates Ad Generator records
   - Creates Upload Queue records
4. **Result**: New ad variants ready for upload

## Troubleshooting

### Common Issues
1. **API not reachable**: Check your project URL and ensure it's running
2. **OpenAI API errors**: Verify your API key and check usage limits
3. **Airtable errors**: Check table names and field names match exactly
4. **Validation failures**: Check character limits (30 for headlines, 90 for descriptions)

### Debug Mode
Set `LOG_LEVEL=debug` in your `.env` file for detailed logging.

### Manual Testing
You can test the API directly:
```bash
curl -X POST https://your-project-url.com/api/generate-ad \
  -H "Content-Type: application/json" \
  -d '{
    "adId": "123456789",
    "campaignId": "987654321",
    "adGroupId": "456789123",
    "campaignName": "Test Campaign",
    "adGroupName": "Test Ad Group",
    "finalUrl": "https://example.com"
  }'
```

## Next Steps
- Monitor the Ad Generator table for generated variants
- Implement the actual Google Ads upload functionality
- Add performance tracking for generated ads
- Set up alerts for failed generations
